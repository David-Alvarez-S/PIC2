/*
 * OLED.c
 *
 * Created: 19/9/2025 0:54:29
 *  Author: David
 */ 
#define F_CPU 16000000UL

#include <avr/io.h>
#include <util/delay.h>
#include <avr/pgmspace.h>
#include "OLED.h"
#include "I2C.h" 

#define OLED_ADDRESS 0x3C // Dirección I2C típica
#define OLED_COMMAND 0x00
#define OLED_DATA 0x40

void OLED_Command(uint8_t cmd) {
	I2C_Start();
	I2C_Write(OLED_ADDRESS << 1); // Dirección + write bit
	I2C_Write(OLED_COMMAND);
	I2C_Write(cmd);
	I2C_Stop();
}

void OLED_Data(uint8_t data) {
	I2C_Start();
	I2C_Write(OLED_ADDRESS << 1);
	I2C_Write(OLED_DATA);
	I2C_Write(data);
	I2C_Stop();
}

void OLED_Init(void) { //Inicializacion del oled, utilizando los comandos dados por el datasheet SSD1306
	
	_delay_ms(100); // Esperar inicialización del OLED
	
	// Secuencia de inicialización
	OLED_Command(0xAE); // Apagamos el display
	
	OLED_Command(0xD5); // Set display clock divide ratio
	OLED_Command(0x80);
	
	OLED_Command(0xA8); // Set multiplex ratio
	OLED_Command(0x3F); // 64-1
	
	OLED_Command(0xD3); // Set display offset
	OLED_Command(0x00); // No offset
	
	OLED_Command(0x40); // Set start line
	
	OLED_Command(0x8D); // Charge pump
	OLED_Command(0x14); // Enable charge pump
	
	OLED_Command(0x20); // Memory mode
	OLED_Command(0x00); // Horizontal addressing
	
	OLED_Command(0xA1); // Segment remap
	OLED_Command(0xC8); // COM output scan direction
	
	OLED_Command(0xDA); // Set COM pins hardware configuration
	OLED_Command(0x12);
	
	OLED_Command(0x81); // Set contrast
	OLED_Command(0xCF);
	
	OLED_Command(0xD9); // Set pre-charge period
	OLED_Command(0xF1);
	
	OLED_Command(0xDB); // Set VCOMH deselect level
	OLED_Command(0x40);
	
	OLED_Command(0xA4); // Entire display on
	OLED_Command(0xA6); // Normal display
	
	OLED_Command(0x2E); // Deactivate scroll
	OLED_Command(0xAF); // Display on
}

void OLED_SetPosition(uint8_t page, uint8_t column) {
	OLED_Command(0xB0 + page); // Set page address
	OLED_Command(0x00 + (column & 0x0F)); // Set lower column address
	OLED_Command(0x10 + ((column >> 4) & 0x0F)); // Set higher column address
}

void OLED_Clear(void) {
	for (uint8_t page = 0; page < 8; page++) {
		OLED_SetPosition(page, 0);
		for (uint8_t col = 0; col < 128; col++) {
			OLED_Data(0x00);
		}
	}
}

const uint8_t font_5x8[] PROGMEM = {
	// Espacio (32)
	0x00, 0x00, 0x00, 0x00, 0x00,
	
	// ! (33)
	0x00, 0x00, 0x5F, 0x00, 0x00,
	
	// " (34)
	0x00, 0x07, 0x00, 0x07, 0x00,
	
	// # (35)
	0x14, 0x7F, 0x14, 0x7F, 0x14,
	
	// $ (36)
	0x24, 0x2A, 0x7F, 0x2A, 0x12,
	
	// % (37)
	0x23, 0x13, 0x08, 0x64, 0x62,
	
	// & (38)
	0x36, 0x49, 0x55, 0x22, 0x50,
	
	// ' (39)
	0x00, 0x05, 0x03, 0x00, 0x00,
	
	// ( (40)
	0x00, 0x1C, 0x22, 0x41, 0x00,
	
	// ) (41)
	0x00, 0x41, 0x22, 0x1C, 0x00,
	
	// * (42)
	0x08, 0x2A, 0x1C, 0x2A, 0x08,
	
	// + (43)
	0x08, 0x08, 0x3E, 0x08, 0x08,
	
	// , (44)
	0x00, 0x50, 0x30, 0x00, 0x00,
	
	// - (45)
	0x18, 0x18, 0x7e, 0x3c, 0x18,
	
	// . (46)
	0x00, 0x60, 0x60, 0x00, 0x00,
	
	// / (47)
	0x20, 0x10, 0x08, 0x04, 0x02,
	
	// 0 (48)
	0x3E, 0x51, 0x49, 0x45, 0x3E,
	
	// 1 (49)
	0x00, 0x42, 0x7F, 0x40, 0x00,
	
	// 2 (50)
	0x42, 0x61, 0x51, 0x49, 0x46,
	
	// 3 (51)
	0x21, 0x41, 0x45, 0x4B, 0x31,
	
	// 4 (52)
	0x18, 0x14, 0x12, 0x7F, 0x10,
	
	// 5 (53)
	0x27, 0x45, 0x45, 0x45, 0x39,
	
	// 6 (54)
	0x3C, 0x4A, 0x49, 0x49, 0x30,
	
	// 7 (55)
	0x01, 0x71, 0x09, 0x05, 0x03,
	
	// 8 (56)
	0x36, 0x49, 0x49, 0x49, 0x36,
	
	// 9 (57)
	0x06, 0x49, 0x49, 0x29, 0x1E,
	
	// : (58)
	0x00, 0x36, 0x36, 0x00, 0x00,
	
	// ; (59)
	0x00, 0x56, 0x36, 0x00, 0x00,
	
	// < (60)
	0x08, 0x14, 0x22, 0x41, 0x00,
	
	// = (61)
	0x14, 0x14, 0x14, 0x14, 0x14,
	
	// > (62)
	0x00, 0x41, 0x22, 0x14, 0x08,
	
	// ? (63)
	0x02, 0x01, 0x51, 0x09, 0x06,
	
	// @ (64)
	0x32, 0x49, 0x79, 0x41, 0x3E,
	
	// A (65)
	0x7E, 0x11, 0x11, 0x11, 0x7E,
	
	// B (66)
	0x7F, 0x49, 0x49, 0x49, 0x36,
	
	// C (67)
	0x3E, 0x41, 0x41, 0x41, 0x22,
	
	// D (68)
	0x7F, 0x41, 0x41, 0x22, 0x1C,
	
	// E (69)
	0x7F, 0x49, 0x49, 0x49, 0x41,
	
	// F (70)
	0x7F, 0x09, 0x09, 0x09, 0x01,
	
	// G (71)
	0x3E, 0x41, 0x49, 0x49, 0x7A,
	
	// H (72)
	0x7F, 0x08, 0x08, 0x08, 0x7F,
	
	// I (73)
	0x00, 0x41, 0x7F, 0x41, 0x00,
	
	// J (74)
	0x20, 0x40, 0x41, 0x3F, 0x01,
	
	// K (75)
	0x7F, 0x08, 0x14, 0x22, 0x41,
	
	// L (76)
	0x7F, 0x40, 0x40, 0x40, 0x40,
	
	// M (77)
	0x7F, 0x02, 0x0C, 0x02, 0x7F,
	
	// N (78)
	0x7F, 0x04, 0x08, 0x10, 0x7F,
	
	// O (79)
	0x3E, 0x41, 0x41, 0x41, 0x3E,
	
	// P (80)
	0x7F, 0x09, 0x09, 0x09, 0x06,
	
	// Q (81)
	0x3E, 0x41, 0x51, 0x21, 0x5E,
	
	// R (82)
	0x7F, 0x09, 0x19, 0x29, 0x46,
	
	// S (83)
	0x46, 0x49, 0x49, 0x49, 0x31,
	
	// T (84)
	0x01, 0x01, 0x7F, 0x01, 0x01,
	
	// U (85)
	0x3F, 0x40, 0x40, 0x40, 0x3F,
	
	// V (86)
	0x1F, 0x20, 0x40, 0x20, 0x1F,
	
	// W (87)
	0x3F, 0x40, 0x38, 0x40, 0x3F,
	
	// X (88)
	0x63, 0x14, 0x08, 0x14, 0x63,
	
	// Y (89)
	0x07, 0x08, 0x70, 0x08, 0x07,
	
	// Z (90)
	0x61, 0x51, 0x49, 0x45, 0x43,
	
	// [ (91)
	0x00, 0x7F, 0x41, 0x41, 0x00,
	
	// \ (92)
	0x02, 0x04, 0x08, 0x10, 0x20,
	
	// ] (93)
	0x00, 0x41, 0x41, 0x7F, 0x00,
	
	// ^ (94)
	0x04, 0x02, 0x01, 0x02, 0x04,
	
	// _ (95)
	0x40, 0x40, 0x40, 0x40, 0x40,
	
	// ` (96)
	0x00, 0x01, 0x02, 0x04, 0x00,
	
	// a (97)
	0x20, 0x54, 0x54, 0x54, 0x78,
	
	// b (98)
	0x7F, 0x48, 0x44, 0x44, 0x38,
	
	// c (99)
	0x38, 0x44, 0x44, 0x44, 0x20,
	
	// d (100)
	0x38, 0x44, 0x44, 0x48, 0x7F, //AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
	
	// e (101)
	0x38, 0x54, 0x54, 0x54, 0x18,
	
	// f (102)
	0x08, 0x7E, 0x09, 0x01, 0x02,
	
	// g (103)
	0x0C, 0x52, 0x52, 0x52, 0x3E,
	
	// h (104)
	0x7F, 0x08, 0x04, 0x04, 0x78,
	
	// i (105)
	0x00, 0x44, 0x7D, 0x40, 0x00,
	
	// j (106)
	0x20, 0x40, 0x44, 0x3D, 0x00,
	
	// k (107)
	0x7F, 0x10, 0x28, 0x44, 0x00, //AAAAAAAAAAAAAAAAAAAAaaa
	
	// l (108)
	0x00, 0x41, 0x7F, 0x40, 0x00,
	
	// m (109)
	0x7C, 0x04, 0x18, 0x04, 0x78,
	
	// n (110)
	0x7C, 0x08, 0x04, 0x04, 0x78,
	
	// o (111)
	0x38, 0x44, 0x44, 0x44, 0x38,
	
	// p (112)
	0x7C, 0x14, 0x14, 0x14, 0x08,
	
	// q (113)
	0x08, 0x14, 0x14, 0x18, 0x7C,
	
	// r (114)
	0x7C, 0x08, 0x04, 0x04, 0x08,
	
	// s (115)
	0x48, 0x54, 0x54, 0x54, 0x20,
	
	// t (116)
	0x04, 0x3F, 0x44, 0x40, 0x20,//AAAAAAAAAAAAAAAAAAAAAAAAAA
	
	// u (117)
	0x3C, 0x40, 0x40, 0x20, 0x7C,
	
	// v (118)
	0x1C, 0x20, 0x40, 0x20, 0x1C,
	
	// w (119)
	0x3C, 0x40, 0x30, 0x40, 0x3C,
	
	// x (120)
	0x44, 0x28, 0x10, 0x28, 0x44,
	
	// y (121)
	0x0C, 0x50, 0x50, 0x50, 0x3C,
	
	// z (122)
	0x44, 0x64, 0x54, 0x4C, 0x44
};

void OLED_DrawChar(uint8_t page, uint8_t col, char c) {
	// Verificar rango del carácter
	if (c < 32 || c > 122) c = '?';
	
	OLED_SetPosition(page, col);
	
	// Leer desde memoria de programa
	for (uint8_t i = 0; i < 5; i++) {
		OLED_Data(pgm_read_byte(&font_5x8[(c - 32) * 5 + i]));
	}
	
	OLED_Data(0x00); // Espacio
}

void OLED_Print(uint8_t page, uint8_t col, const char *str) {
	while (*str) {
		OLED_DrawChar(page, col, *str++);
		col += 6;
		if (col > 122) {
			col = 0;
			page++;
		}
	}
}